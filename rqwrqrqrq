#!/usr/bin/env python3
"""
NETWORK TESTER PRO v2.0 - Indonesian Edition
Tes Kecepatan Internet & Monitor Ping Gaming Profesional
Author: dANZ Cyber Team
Version: 2.0
"""

import time
import socket
import requests
import threading
import statistics
from datetime import datetime
from collections import deque
import subprocess
import platform
import struct

from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.live import Live
from rich.layout import Layout
from rich.progress import Progress, SpinnerColumn, BarColumn, TextColumn
from rich import box
from rich.text import Text
from rich.columns import Columns

console = Console()

BANNER = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                           â•‘
â•‘   â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—        â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•        â•‘
â•‘   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•         â•‘
â•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—         â•‘
â•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—        â•‘
â•‘   â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•    â•šâ•â•â•â•šâ•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•        â•‘
â•‘                                                                           â•‘
â•‘          [ Suite Profesional untuk Testing Jaringan v2.0 ]               â•‘
â•‘             [ Tes Kecepatan & Monitor Ping Gaming ]                      â•‘
â•‘                                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

# Server gaming untuk tes ping - DIPERLUAS
GAMING_SERVERS = {
    'Indonesia': [
        ('Telkom Indonesia', '202.152.0.2'),
        ('Indosat', '202.155.0.10'),
        ('Biznet', '202.169.224.1'),
        ('MyRepublic ID', '103.161.184.3'),
        ('Point Blank Garena', '103.20.188.1'),
    ],
    'Singapore': [
        ('Valve Singapore', '103.28.54.10'),
        ('Riot Singapore', '13.228.26.8'),
        ('Garena Singapore', '103.20.188.1'),
        ('Singtel', '165.21.83.88'),
        ('StarHub', '202.166.120.12'),
    ],
    'Malaysia': [
        ('Maxis Malaysia', '202.75.208.1'),
        ('TM Net', '210.187.85.1'),
        ('Time Malaysia', '110.4.46.100'),
    ],
    'Thailand': [
        ('TRUE Thailand', '202.44.55.1'),
        ('AIS Thailand', '203.114.224.8'),
    ],
    'Vietnam': [
        ('VNPT Vietnam', '203.162.0.181'),
        ('Viettel', '203.113.131.1'),
    ],
    'Filipina': [
        ('PLDT Philippines', '202.90.128.1'),
        ('Globe Philippines', '112.198.97.1'),
    ],
    'Hong Kong': [
        ('HKT Hong Kong', '202.140.96.1'),
        ('PCCW', '203.80.96.10'),
    ],
    'Taiwan': [
        ('HiNet Taiwan', '168.95.192.1'),
        ('Taiwan Mobile', '211.72.254.1'),
    ],
    'Korea Selatan': [
        ('KT Korea', '168.126.63.1'),
        ('LG U+ Korea', '164.124.101.2'),
    ],
    'Jepang': [
        ('Tokyo Server', '203.178.143.70'),
        ('NTT Japan', '210.150.11.1'),
        ('Softbank Japan', '210.188.224.9'),
    ],
    'Australia': [
        ('Telstra Australia', '139.130.4.5'),
        ('Optus Australia', '211.29.132.12'),
    ],
    'US West': [
        ('Los Angeles', '104.160.141.3'),
        ('Seattle', '104.160.152.1'),
    ],
    'US East': [
        ('New York', '104.160.131.3'),
        ('Miami', '104.160.142.3'),
    ],
    'Eropa': [
        ('Amsterdam', '185.25.182.10'),
        ('Frankfurt', '185.25.180.10'),
        ('London', '185.25.183.10'),
        ('Paris', '185.25.181.10'),
    ],
}

# DNS Gaming Terbaik
DNS_SERVERS = {
    'Google DNS': [
        ('Google Primary', '8.8.8.8'),
        ('Google Secondary', '8.8.4.4'),
    ],
    'Cloudflare': [
        ('Cloudflare Primary', '1.1.1.1'),
        ('Cloudflare Secondary', '1.0.0.1'),
        ('Cloudflare Gaming', '1.1.1.2'),  # Optimized for gaming
    ],
    'Quad9': [
        ('Quad9 Primary', '9.9.9.9'),
        ('Quad9 Secondary', '149.112.112.112'),
    ],
    'OpenDNS': [
        ('OpenDNS Primary', '208.67.222.222'),
        ('OpenDNS Secondary', '208.67.220.220'),
    ],
    'Level3': [
        ('Level3 Primary', '209.244.0.3'),
        ('Level3 Secondary', '209.244.0.4'),
    ],
    'Comodo': [
        ('Comodo Secure', '8.26.56.26'),
        ('Comodo Secure 2', '8.20.247.20'),
    ],
    'AdGuard DNS': [
        ('AdGuard Default', '94.140.14.14'),
        ('AdGuard Family', '94.140.14.15'),
    ],
    'DNS.WATCH': [
        ('DNS.WATCH Primary', '84.200.69.80'),
        ('DNS.WATCH Secondary', '84.200.70.40'),
    ],
}


class SpeedTester:
    """Engine Tes Kecepatan Internet"""
    
    def __init__(self):
        self.download_speed = 0
        self.upload_speed = 0
        self.latency = 0
        self.jitter = 0
        self.packet_loss = 0
        self.test_server = "speedtest.tele2.net"
        self.results = []
        
    def test_latency(self, host='8.8.8.8', count=10):
        """Tes latensi dengan ping"""
        console.log(f"[+] Mengetes latensi ke {host}...")
        latencies = []
        
        try:
            param = '-n' if platform.system().lower() == 'windows' else '-c'
            
            for i in range(count):
                try:
                    result = subprocess.run(
                        ['ping', param, '1', host],
                        capture_output=True,
                        text=True,
                        timeout=2
                    )
                    
                    output = result.stdout
                    
                    # Parse ping time
                    if 'time=' in output:
                        time_str = output.split('time=')[1].split()[0]
                        time_ms = float(time_str.replace('ms', ''))
                        latencies.append(time_ms)
                    elif 'time<' in output:
                        latencies.append(1)
                        
                except Exception:
                    pass
                
                time.sleep(0.1)
            
            if latencies:
                self.latency = statistics.mean(latencies)
                self.jitter = statistics.stdev(latencies) if len(latencies) > 1 else 0
                self.packet_loss = ((count - len(latencies)) / count) * 100
            else:
                self.latency = 999
                self.jitter = 0
                self.packet_loss = 100
                
        except Exception as e:
            console.log(f"[!] Tes latensi gagal: {e}")
            self.latency = 999
    
    def test_download(self, url, size_mb):
        """Tes kecepatan download"""
        try:
            start = time.time()
            response = requests.get(url, timeout=30, stream=True)
            
            downloaded = 0
            for chunk in response.iter_content(chunk_size=8192):
                downloaded += len(chunk)
            
            elapsed = time.time() - start
            
            # Hitung kecepatan dalam Mbps
            speed_mbps = (downloaded * 8) / (elapsed * 1_000_000)
            return speed_mbps
            
        except Exception as e:
            console.log(f"[!] Tes download gagal: {e}")
            return 0
    
    def test_upload(self, size_mb=1):
        """Tes kecepatan upload"""
        try:
            # Generate random data
            data = b'0' * (size_mb * 1024 * 1024)
            
            start = time.time()
            response = requests.post(
                'https://httpbin.org/post',
                data=data,
                timeout=30
            )
            elapsed = time.time() - start
            
            # Hitung kecepatan dalam Mbps
            speed_mbps = (len(data) * 8) / (elapsed * 1_000_000)
            return speed_mbps
            
        except Exception as e:
            console.log(f"[!] Tes upload gagal: {e}")
            return 0
    
    def run_speed_test(self):
        """Jalankan tes kecepatan lengkap"""
        console.print("\n")
        console.rule("[bold cyan][*] Memulai Tes Kecepatan[/bold cyan]", style="cyan")
        console.print()
        
        # Tes latensi
        with console.status("[bold green][+] Mengetes latensi...", spinner="dots"):
            self.test_latency()
        
        console.log(f"[+] Latensi: {self.latency:.1f}ms | Jitter: {self.jitter:.1f}ms | Packet Loss: {self.packet_loss:.1f}%")
        
        # Tes download
        console.print()
        console.log("[+] Mengetes kecepatan download...")
        
        SPEED_TEST_URLS = [
            ('1MB', 'http://speedtest.tele2.net/1MB.zip', 1),
            ('10MB', 'http://speedtest.tele2.net/10MB.zip', 10),
        ]
        
        progress = Progress(
            SpinnerColumn(),
            TextColumn("[bold blue]{task.description}"),
            BarColumn(bar_width=40),
            TextColumn("[cyan]{task.fields[speed]}"),
            console=console
        )
        
        with progress:
            download_speeds = []
            
            for name, url, size in SPEED_TEST_URLS:
                task = progress.add_task(
                    f"[+] Download {name}...",
                    total=100,
                    speed="0.00 Mbps"
                )
                
                speed = self.test_download(url, size)
                download_speeds.append(speed)
                
                progress.update(task, completed=100, speed=f"{speed:.2f} Mbps")
            
            self.download_speed = max(download_speeds) if download_speeds else 0
        
        console.log(f"[+] Kecepatan download: {self.download_speed:.2f} Mbps")
        
        # Tes upload
        console.print()
        with console.status("[bold green][+] Mengetes kecepatan upload...", spinner="dots"):
            self.upload_speed = self.test_upload(1)
        
        console.log(f"[+] Kecepatan upload: {self.upload_speed:.2f} Mbps")
        
        return self.generate_speed_report()
    
    def generate_speed_report(self):
        """Generate laporan tes kecepatan"""
        console.print("\n")
        console.rule("[bold cyan][*] Hasil Tes Kecepatan[/bold cyan]", style="cyan")
        console.print()
        
        # Penilaian latensi
        if self.latency < 20:
            latency_status = "[green]SANGAT BAGUS[/green]"
        elif self.latency < 50:
            latency_status = "[green]BAGUS[/green]"
        elif self.latency < 100:
            latency_status = "[yellow]CUKUP[/yellow]"
        else:
            latency_status = "[red]BURUK[/red]"
        
        # Penilaian download
        if self.download_speed > 100:
            download_status = "[green]SANGAT BAGUS[/green]"
        elif self.download_speed > 50:
            download_status = "[green]BAGUS[/green]"
        elif self.download_speed > 10:
            download_status = "[yellow]CUKUP[/yellow]"
        else:
            download_status = "[red]BURUK[/red]"
        
        # Penilaian upload
        if self.upload_speed > 50:
            upload_status = "[green]SANGAT BAGUS[/green]"
        elif self.upload_speed > 10:
            upload_status = "[green]BAGUS[/green]"
        elif self.upload_speed > 5:
            upload_status = "[yellow]CUKUP[/yellow]"
        else:
            upload_status = "[red]BURUK[/red]"
        
        # Tabel hasil
        results_table = Table(show_header=True, box=box.ROUNDED, border_style="cyan")
        results_table.add_column("Metrik", style="yellow bold", width=25)
        results_table.add_column("Nilai", style="white", width=20)
        results_table.add_column("Status", style="cyan", width=20)
        
        results_table.add_row(
            "[+] Kecepatan Download",
            f"{self.download_speed:.2f} Mbps",
            download_status
        )
        
        results_table.add_row(
            "[+] Kecepatan Upload",
            f"{self.upload_speed:.2f} Mbps",
            upload_status
        )
        
        results_table.add_row(
            "[+] Latensi",
            f"{self.latency:.1f} ms",
            latency_status
        )
        
        results_table.add_row(
            "[+] Jitter",
            f"{self.jitter:.1f} ms",
            "[green]RENDAH[/green]" if self.jitter < 10 else "[yellow]SEDANG[/yellow]" if self.jitter < 30 else "[red]TINGGI[/red]"
        )
        
        results_table.add_row(
            "[+] Packet Loss",
            f"{self.packet_loss:.1f}%",
            "[green]TIDAK ADA[/green]" if self.packet_loss == 0 else "[yellow]SEDIKIT[/yellow]" if self.packet_loss < 5 else "[red]TINGGI[/red]"
        )
        
        console.print(Panel(
            results_table,
            title="[bold cyan][*] Hasil Tes Kecepatan Internet[/bold cyan]",
            border_style="cyan",
            box=box.DOUBLE
        ))
        
        # Rekomendasi
        recommendations = []
        
        if self.download_speed < 10:
            recommendations.append("[!] Kecepatan download lambat - Pertimbangkan upgrade paket internet")
        
        if self.upload_speed < 5:
            recommendations.append("[!] Kecepatan upload lambat - Dapat mempengaruhi video call dan streaming")
        
        if self.latency > 100:
            recommendations.append("[!] Latensi tinggi terdeteksi - Tidak cocok untuk gaming")
        
        if self.jitter > 30:
            recommendations.append("[!] Jitter tinggi - Dapat menyebabkan koneksi tidak stabil")
        
        if self.packet_loss > 5:
            recommendations.append("[!] Packet loss terdeteksi - Periksa perangkat jaringan Anda")
        
        if not recommendations:
            recommendations.append("[+] Koneksi Anda bekerja dengan baik!")
        
        if recommendations:
            console.print()
            rec_panel = "\n".join(recommendations)
            console.print(Panel(
                rec_panel,
                title="[bold yellow][*] Rekomendasi[/bold yellow]",
                border_style="yellow"
            ))
        
        console.print()


class GamingPingTester:
    """Tester Ping Server Gaming"""
    
    def __init__(self):
        self.results = {}
        self.dns_results = {}
        self.running = True
        
    def tcp_ping(self, host, port=80, timeout=2):
        """Ping TCP lebih akurat dari socket connect"""
        try:
            # Resolve IP first
            try:
                ip = socket.gethostbyname(host)
            except:
                ip = host
            
            # TCP connect timing
            start = time.time()
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(timeout)
            
            result = sock.connect_ex((ip, port))
            latency = (time.time() - start) * 1000
            
            sock.close()
            
            if result == 0:
                return latency
            else:
                return None
                
        except Exception:
            return None
    
    def icmp_ping(self, host, timeout=2):
        """ICMP ping menggunakan subprocess (lebih reliable)"""
        try:
            param = '-n' if platform.system().lower() == 'windows' else '-c'
            timeout_param = '-w' if platform.system().lower() == 'windows' else '-W'
            
            result = subprocess.run(
                ['ping', param, '1', timeout_param, str(int(timeout * 1000)) if platform.system().lower() == 'windows' else str(timeout), host],
                capture_output=True,
                text=True,
                timeout=timeout + 1
            )
            
            output = result.stdout
            
            # Parse ping time
            if 'time=' in output:
                time_str = output.split('time=')[1].split()[0]
                time_ms = float(time_str.replace('ms', '').replace('<', ''))
                return time_ms
            elif 'time<' in output:
                return 1
            else:
                return None
                
        except Exception:
            return None
    
    def ping_server(self, host, port=80, timeout=2):
        """Ping server dengan multiple methods"""
        # Try ICMP first (more accurate for gaming)
        latency = self.icmp_ping(host, timeout)
        
        # Fallback to TCP if ICMP fails
        if latency is None:
            latency = self.tcp_ping(host, port, timeout)
        
        return latency
    
    def test_server_continuously(self, name, host, duration=10):
        """Tes server secara kontinyu"""
        console.log(f"[+] Mengetes {name} ({host})...")
        
        latencies = []
        start_time = time.time()
        samples = 0
        
        while time.time() - start_time < duration:
            latency = self.ping_server(host)
            samples += 1
            
            if latency is not None:
                latencies.append(latency)
            
            time.sleep(0.3)  # Test every 300ms
        
        if latencies:
            packet_loss = ((samples - len(latencies)) / samples) * 100 if samples > 0 else 100
            
            return {
                'min': min(latencies),
                'max': max(latencies),
                'avg': statistics.mean(latencies),
                'jitter': statistics.stdev(latencies) if len(latencies) > 1 else 0,
                'packet_loss': packet_loss,
                'samples': len(latencies),
                'reachable': True
            }
        else:
            return {
                'min': 999,
                'max': 999,
                'avg': 999,
                'jitter': 0,
                'packet_loss': 100,
                'samples': 0,
                'reachable': False
            }
    
    def run_gaming_test(self, duration=10):
        """Jalankan tes ping gaming"""
        console.print("\n")
        console.rule("[bold cyan][*] Memulai Tes Ping Gaming[/bold cyan]", style="cyan")
        console.print()
        
        console.log(f"[+] Durasi tes: {duration} detik per server")
        console.log("[+] Mengetes server gaming di seluruh dunia...")
        console.print()
        
        # Tes setiap region
        for region, servers in GAMING_SERVERS.items():
            console.log(f"[*] Mengetes server {region}...")
            
            self.results[region] = {}
            
            for name, host in servers:
                stats = self.test_server_continuously(name, host, duration)
                self.results[region][name] = stats
            
            console.print()
        
        # Tes DNS servers
        console.log("[*] Mengetes DNS Servers untuk Gaming...")
        console.print()
        
        for dns_provider, dns_list in DNS_SERVERS.items():
            self.dns_results[dns_provider] = {}
            
            for name, host in dns_list:
                console.log(f"[+] Mengetes {name} ({host})...")
                stats = self.test_server_continuously(name, host, duration)
                self.dns_results[dns_provider][name] = stats
        
        console.print()
        
        return self.generate_gaming_report()
    
    def generate_gaming_report(self):
        """Generate laporan tes ping gaming"""
        console.print()
        console.rule("[bold cyan][*] Hasil Tes Ping Gaming[/bold cyan]", style="cyan")
        console.print()
        
        # Cari server terbaik
        best_servers = []
        
        for region, servers in self.results.items():
            for name, stats in servers.items():
                if stats['reachable'] and stats['avg'] < 999:
                    best_servers.append({
                        'region': region,
                        'name': name,
                        'avg': stats['avg'],
                        'jitter': stats['jitter'],
                        'packet_loss': stats['packet_loss']
                    })
        
        # Sort berdasarkan latensi
        best_servers.sort(key=lambda x: x['avg'])
        
        # Tabel server terbaik
        if best_servers:
            best_table = Table(show_header=True, box=box.ROUNDED, border_style="green")
            best_table.add_column("Rank", style="cyan bold", width=6)
            best_table.add_column("Server", style="white", width=30)
            best_table.add_column("Region", style="yellow", width=18)
            best_table.add_column("Ping", style="green", width=12)
            best_table.add_column("Jitter", style="magenta", width=12)
            best_table.add_column("Status", style="cyan", width=18)
            
            for i, server in enumerate(best_servers[:15], 1):
                ping = server['avg']
                jitter = server['jitter']
                
                # Penilaian status
                if ping < 30:
                    status = "[green]SANGAT BAGUS[/green]"
                elif ping < 50:
                    status = "[green]BAGUS[/green]"
                elif ping < 100:
                    status = "[yellow]CUKUP[/yellow]"
                else:
                    status = "[red]BURUK[/red]"
                
                best_table.add_row(
                    f"#{i}",
                    server['name'],
                    server['region'],
                    f"{ping:.1f} ms",
                    f"{jitter:.1f} ms",
                    status
                )
            
            console.print(Panel(
                best_table,
                title="[bold green][*] Server Gaming Terbaik (Urut berdasarkan Latensi)[/bold green]",
                border_style="green",
                box=box.DOUBLE
            ))
        
        # Breakdown regional
        console.print()
        console.rule("[bold yellow][*] Rincian Per-Region[/bold yellow]", style="yellow")
        console.print()
        
        for region, servers in self.results.items():
            region_table = Table(show_header=True, box=box.SIMPLE, border_style="cyan")
            region_table.add_column("Server", style="white bold", width=30)
            region_table.add_column("Avg Ping", style="green", width=12)
            region_table.add_column("Min/Max", style="yellow", width=18)
            region_table.add_column("Jitter", style="magenta", width=12)
            region_table.add_column("Loss", style="red", width=10)
            region_table.add_column("Status", style="cyan", width=18)
            
            for name, stats in servers.items():
                if stats['reachable']:
                    # Status
                    if stats['avg'] < 30:
                        status = "[green]SANGAT BAGUS[/green]"
                    elif stats['avg'] < 50:
                        status = "[green]BAGUS[/green]"
                    elif stats['avg'] < 100:
                        status = "[yellow]CUKUP[/yellow]"
                    else:
                        status = "[red]BURUK[/red]"
                    
                    region_table.add_row(
                        name,
                        f"{stats['avg']:.1f} ms",
                        f"{stats['min']:.1f}/{stats['max']:.1f}",
                        f"{stats['jitter']:.1f} ms",
                        f"{stats['packet_loss']:.1f}%",
                        status
                    )
                else:
                    region_table.add_row(
                        name,
                        "[red]TIMEOUT[/red]",
                        "[red]---[/red]",
                        "[red]---[/red]",
                        "[red]100%[/red]",
                        "[red]TIDAK TERJANGKAU[/red]"
                    )
            
            console.print(Panel(
                region_table,
                title=f"[bold cyan][*] Server {region}[/bold cyan]",
                border_style="cyan"
            ))
            console.print()
        
        # Hasil DNS
        console.rule("[bold magenta][*] Hasil Tes DNS untuk Gaming[/bold magenta]", style="magenta")
        console.print()
        
        # Cari DNS terbaik
        best_dns = []
        for dns_provider, dns_list in self.dns_results.items():
            for name, stats in dns_list.items():
                if stats['reachable']:
                    best_dns.append({
                        'provider': dns_provider,
                        'name': name,
                        'avg': stats['avg'],
                        'jitter': stats['jitter']
                    })
        
        best_dns.sort(key=lambda x: x['avg'])
        
        if best_dns:
            dns_table = Table(show_header=True, box=box.ROUNDED, border_style="magenta")
            dns_table.add_column("Rank", style="cyan bold", width=6)
            dns_table.add_column("Provider", style="yellow", width=20)
            dns_table.add_column("DNS Server", style="white", width=30)
            dns_table.add_column("Ping", style="green", width=12)
            dns_table.add_column("Jitter", style="magenta", width=12)
            dns_table.add_column("Rekomendasi", style="cyan", width=15)
            
            for i, dns in enumerate(best_dns[:10], 1):
                recommendation = "â­ TERBAIK" if i == 1 else "âœ… BAGUS" if i <= 3 else "ğŸ‘ OK"
                
                dns_table.add_row(
                    f"#{i}",
                    dns['provider'],
                    dns['name'],
                    f"{dns['avg']:.1f} ms",
                    f"{dns['jitter']:.1f} ms",
                    recommendation
                )
            
            console.print(Panel(
                dns_table,
                title="[bold magenta][*] DNS Terbaik untuk Gaming[/bold magenta]",
                border_style="magenta",
                box=box.DOUBLE
            ))
        
        # Rekomendasi gaming & DNS
        console.print()
        
        if best_servers:
            best = best_servers[0]
            
            recommendations = []
            recommendations.append(f"[+] Server terbaik untuk Anda: {best['name']} ({best['region']})")
            recommendations.append(f"[+] Rata-rata ping: {best['avg']:.1f}ms")
            
            if best['avg'] < 30:
                recommendations.append("[+] SANGAT BAGUS untuk gaming kompetitif (FPS, MOBA, Fighting)")
            elif best['avg'] < 50:
                recommendations.append("[+] BAGUS untuk semua jenis game online")
            elif best['avg'] < 100:
                recommendations.append("[!] CUKUP - Mungkin mengalami sedikit delay")
            else:
                recommendations.append("[!] LATENSI TINGGI - Tidak direkomendasikan untuk game fast-paced")
            
            if best['jitter'] > 10:
                recommendations.append("[!] Jitter sedang terdeteksi - Koneksi mungkin tidak stabil")
            
            if best['packet_loss'] > 1:
                recommendations.append(f"[!] Packet loss terdeteksi ({best['packet_loss']:.1f}%) - Periksa koneksi Anda")
            
            # Rekomendasi DNS
            if best_dns:
                best_dns_server = best_dns[0]
                recommendations.append("")
                recommendations.append("[*] Rekomendasi DNS untuk Gaming:")
                recommendations.append(f"[+] DNS Terbaik: {best_dns_server['provider']} - {best_dns_server['name']}")
                recommendations.append(f"[+] Ping DNS: {best_dns_server['avg']:.1f}ms")
                recommendations.append("[+] Ganti DNS Anda untuk performa gaming lebih baik!")
                
                # Cara ganti DNS
                recommendations.append("")
                recommendations.append("[*] Cara Ganti DNS di Windows:")
                recommendations.append("    1. Buka Control Panel > Network and Sharing Center")
                recommendations.append("    2. Klik 'Change adapter settings'")
                recommendations.append("    3. Klik kanan koneksi Anda > Properties")
                recommendations.append("    4. Pilih 'Internet Protocol Version 4 (TCP/IPv4)' > Properties")
                recommendations.append(f"    5. Pilih 'Use the following DNS server addresses'")
                recommendations.append(f"    6. Masukkan DNS yang direkomendasi")
            
            console.print(Panel(
                "\n".join(recommendations),
                title="[bold yellow][*] Rekomendasi Gaming & DNS[/bold yellow]",
                border_style="yellow"
            ))
        
        console.print()


def main():
    """Main entry point"""
    console.clear()
    console.print(BANNER, style="bold cyan")
    
    # Menu
    menu = Panel(
        """
[bold cyan]Pilih Mode Tes:[/bold cyan]

[yellow][1][/yellow] Tes Kecepatan Internet
    [+] Kecepatan Download & Upload
    [+] Latensi & Jitter
    [+] Deteksi Packet Loss
    [+] Penilaian Kualitas Koneksi

[yellow][2][/yellow] Tes Ping Gaming
    [+] Tes server gaming di seluruh dunia
    [+] Server Indonesia, Asia, Global
    [+] Point Blank, Valve, Riot, dll
    [+] Rekomendasi server terbaik
    [+] Tes 25+ DNS Gaming
    [+] Rekomendasi DNS terbaik untuk gaming
    [+] Analisis jitter & stabilitas

[yellow][3][/yellow] Jalankan Kedua Tes

[yellow][0][/yellow] Keluar
        """,
        title="[bold green][*] Network Tester Pro v2.0 - Indonesian Edition[/bold green]",
        border_style="green",
        box=box.DOUBLE
    )
    
    console.print(menu)
    console.print()
    
    choice = console.input("[cyan][?] Masukkan pilihan Anda (1/2/3/0):[/cyan] ").strip()
    
    if choice == "1":
        # Tes Kecepatan
        tester = SpeedTester()
        tester.run_speed_test()
        
    elif choice == "2":
        # Tes Ping Gaming
        duration_input = console.input("\n[cyan][?] Durasi tes per server dalam detik [10]:[/cyan] ").strip()
        duration = int(duration_input) if duration_input else 10
        
        tester = GamingPingTester()
        tester.run_gaming_test(duration)
        
    elif choice == "3":
        # Kedua tes
        console.print("\n[bold yellow][*] Menjalankan tes jaringan komprehensif...[/bold yellow]")
        
        # Tes kecepatan dulu
        speed_tester = SpeedTester()
        speed_tester.run_speed_test()
        
        console.print("\n")
        console.input("[cyan][+] Tekan Enter untuk lanjut ke Tes Ping Gaming...[/cyan]")
        
        # Tes gaming
        duration_input = console.input("\n[cyan][?] Durasi tes per server dalam detik [10]:[/cyan] ").strip()
        duration = int(duration_input) if duration_input else 10
        
        gaming_tester = GamingPingTester()
        gaming_tester.run_gaming_test(duration)
        
    elif choice == "0":
        console.print("[yellow][+] Keluar...[/yellow]")
        return
    else:
        console.print("[red][!] Pilihan tidak valid[/red]")
        return
    
    console.print()
    console.rule("[bold cyan][*] Tes Selesai[/bold cyan]", style="cyan")
    console.print()


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        console.print("\n[yellow][!] Tes diberhentikan oleh pengguna[/yellow]")
    except Exception as e:
        console.print(f"\n[red][!] Error: {e}[/red]")

